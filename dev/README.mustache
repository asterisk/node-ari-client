# About

This module contains the Node.js client library for the Asterisk REST Interface.
It builds upon the swagger-js library, providing an improved, Asterisk-specific
API over the API generated by swagger-js.

# Usage

## Installation

```bash
$ npm install ari-client
```

## API

The client exposes a connect function that can be used to connect to an instance
of ARI and to configure a client with all available resources and operations.

```javascript
var client = require('ari-client');
client.connect(url, username, password, function (err, ari) {})
```

Upon connecting, a callback will be called passing a reference to a client with
all available resources attached.

```
ari.bridges, ari.channels, ari.endpoints...
```

Those properties expose operations that can be performed for that given resource.

```javascript
ari.bridges.list(function (err, bridges) {});
ari.bridges.get({bridgeId: 'uniqueid'}, function (err, bridge) {});
```

Operations that return a resource or a list of resources expose the same operations tied to that given instance.

```javascript
bridge.addChannel({channel: 'uniqueid'});
```

Note that the bridge id was not required since the operation was called from a resource instance. The above operation is equivalent to the following:

```javascript
ari.bridges.addChannel({bridgeId: 'uniqueid', channel: 'uniqueid'});
```

The client also exposes functions to create new resources.

```
ari.Bridge(), ari.Channel(), ari.Playback(), ari.LiveRecording()
```

The instance returned by these functions can then be used to call a create operations in ARI.

```javascript
var bridge = ari.Bridge();
bridge.create(function (err, bridge) {});
```

Note that the create operation returns an updated copy of the bridge after creation.

Using this method of resource creation, it is possible to register event listeners for a resource before it is created in ARI.

```javascript
var channel = ari.Channel();
channel.on('StasisStart', function (event, channel) {});
channel.on('ChannelDtmfReceived', function (event, channel) {});
channel.originate(
    {endpoint: 'SIP/1000', app: 'application', appArgs: 'dialed'},
    function(err, channel) {}
);
```

Some create operations require an instance be passed in for this to work.

```javascript
var playback = ari.Playback();
channel.play({media: 'sound:hello-world'}, playback, function (err, playback) {});
```

If you are using the client directly to call a create operation instead of using an instance, you will have to pass the appropriate ids as part of the options to the create operation.

```javascript
var playback = ari.Playback();
ari.channels.play({
  media: 'sound:hello-world',
  channelId: channel.id,
  playbackId: playback.id
}, function (err, playback) {});
```

### Operations

The following operations are defined:

{{{operations}}}
### Events

Event listeners can be registered on the client as well as on resource instances. Note that resource instance listeners are tied to the instance while client listeners receive all events of a given type regardless of which resource the event is for.

The following events are defined:

#### APILoadError

ARI client failed to load.

```javascript
function (err) {}
```

#### WebSocketMaxRetries

Client will no longer attempt to reconnect to the WebSocket for the current application(s).

```JavaScript
function (err) {}
```

{{{events}}}

# Examples

Replace ari.js with your Asterisk instance.

```javascript
var client = require('ari-client'),
    util = require('util');

client.connect('http://ari.js:8088', 'user', 'secret', client_loaded);

function client_loaded (err, ari) {

    ari.once('StasisStart', channel_joined);

    function channel_joined (event, incoming) {
        incoming.on('ChannelDtmfReceived', dtmf_received);

        incoming.answer(function (err) {
            play(incoming, 'sound:hello-world');
        });
    }

    function dtmf_received (event, channel) {
        var digit = event.digit;
        switch (digit) {
            case '#':
                play(channel, 'sound:vm-goodbye', function (err) {
                    channel.hangup(function (err) {
                        process.exit(0);
                    });
                });
                break;
            case '*':
                play(channel, 'sound:tt-monkeys');
                break;
            default:
                play(channel, util.format('sound:digits/%s', digit));
        }
    }

    function play (channel, sound, callback) {
        var playback = ari.Playback();
        playback.on('PlaybackFinished', function (event, playback) {
            if (callback) {
                callback(null);
            }
        });
        channel.play({media: sound}, playback, function (err, playback) { });
    }

    ari.start('hello');
}
```

# Testing

To run the mocha tests for ari-client, run the following:

```bash
grunt mochaTest
```

The tests run against a mocked ARI REST endpoint and websocket server.

# Development

After cloning the git repository, run the following to install all dev dependencies:

```bash
npm install
npm link
```

Then run the following to run jshint and mocha tests:

```bash
grunt
```

jshint will enforce a minimal style guide. It is also a good idea to create unit tests when adding new features to ari-client.

To generate a test coverage report run the following:

```bash
$ grunt coverage
```

This will also ensure a coverage threshold is met by the tests.

Unit test fixtures for ARI resources can be generated from a local asterisk instance by running the following:

```bash
grunt genfixtures
```

Once you have done this and loaded a mocked ARI server, individual calls can be mocked using the hock library. Websocket events can be mocked by creating a websocket server and calling its send method. The helpers module exposes methods for creating a mocked ARI server and a mocked websocket server for use in writing unit tests.

Developer documentation can ge generated by running the following:

```bash
grunt jsdoc
```

# License

Apache, Version 2.0. Copyright (c) 2014, Digium, Inc. All rights reserved.
